<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø³Ùˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© | Ø´Ø§ØªÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --accent-color: #58a6ff;
            --success-color: #238636;
            --error-color: #da3633;
            --border-color: #30363d;
            --hover-color: #1f6feb;
        }

        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; }
        header { text-align: center; padding: 25px; background: #161b22; border-bottom: 1px solid var(--border-color); }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        #searchBar {
            width: 100%; max-width: 400px; padding: 12px; margin: 10px auto; display: block;
            border-radius: 8px; border: 1px solid var(--border-color); background: #0d1117; color: white;
        }

        .exams-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 20px; }
        .exam-card { background: var(--card-bg); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .exam-card:hover { border-color: var(--accent-color); transform: translateY(-5px); }

        #quiz-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1000; display: none; overflow-y: auto; padding: 20px; }
        .question-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .opt-btn { background: #21262d; border: 1px solid var(--border-color); color: var(--text-color); padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 8px; text-align: right; font-family: inherit; }
        .opt-btn.selected { background: var(--hover-color); border-color: white; }

        .btn-submit { background: var(--success-color); color: white; padding: 15px 40px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; display: block; margin: 20px auto; font-family: inherit; }
        #result-display { padding: 20px; background: #161b22; border: 2px solid var(--accent-color); border-radius: 15px; margin-top: 20px; display: none; }
        
        .correct { color: #3fb950; font-weight: bold; }
        .wrong { color: #f85149; font-weight: bold; }
        .q-result { border-bottom: 1px solid var(--border-color); padding: 10px 0; }
    </style>
</head>
<body>

<div id="dashboard">
    <header>
        <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø³Ùˆ ğŸš€</h1>
        <input type="text" id="searchBar" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...">
    </header>
    <div class="container">
        <div class="exams-grid" id="exams-list"></div>
    </div>
</div>

<div id="quiz-overlay">
    <div class="container">
        <button onclick="location.reload()" style="background:none; border:none; color:var(--accent-color); cursor:pointer; font-size:1.1rem;">â¬… Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <h2 id="quiz-title" style="margin-top:20px;"></h2>
        <div id="quiz-questions"></div>
        
        <div id="result-display">
            <h2 style="text-align:center;">ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <div id="result-summary" style="text-align:center; font-size:1.3rem; margin-bottom:20px;"></div>
            <div id="result-details"></div>
        </div>

        <button class="btn-submit" id="submit-btn" onclick="submitExam()">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø³ÙŠØ±ÙØ±</button>
    </div>
</div>

<script>
    let currentId = null;
    let userAnswers = {}; 
    const TOKEN = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo1MTM1OSwicm9sZSI6InN0dWRlbnQiLCJ1dWlkIjoiNDAyOTZkM2YxMDg4ZGM5ZjRmMWQ2MTE0ZjcwM2U2MDQifQ.RoPKriladUHqzewaO3D1F9_XWVdLiqyYRh_06aorQQI";

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù† 42 Ù„Ù€ 700
    const list = document.getElementById('exams-list');
    for(let i=42; i<=700; i++) {
        const div = document.createElement('div');
        div.className = 'exam-card';
        div.innerHTML = `<h3>Ø§Ø®ØªØ¨Ø§Ø± #${i}</h3>`;
        div.onclick = () => openQuiz(i);
        list.appendChild(div);
    }

    // Ø¨Ø­Ø«
    document.getElementById('searchBar').oninput = (e) => {
        const val = e.target.value;
        document.querySelectorAll('.exam-card').forEach(c => {
            c.style.display = c.innerText.includes(val) ? 'block' : 'none';
        });
    };

    async function openQuiz(id) {
        currentId = id;
        userAnswers = {};
        document.getElementById('quiz-overlay').style.display = 'block';
        document.getElementById('result-display').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'block';
        const qDiv = document.getElementById('quiz-questions');
        qDiv.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ù…Ù„ÙØ§ØªÙƒ...';

        try {
            const res = await fetch(`Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª/exam_${id}.json`);
            const json = await res.json();
            const data = json.data.data;
            document.getElementById('quiz-title').innerText = data.exam.title;
            qDiv.innerHTML = '';

            data.questions.forEach(q => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.innerHTML = `
                    <p><strong>${q.text}</strong></p>
                    ${q.image_url ? `<img src="${q.image_url}" style="max-width:100%; border-radius:8px;">` : ''}
                    <div id="group-${q.id}">
                        ${q.answers.map(a => `<button class="opt-btn" onclick="save('${q.id}', '${a.id}', this)">${a.text}</button>`).join('')}
                    </div>
                `;
                qDiv.appendChild(card);
            });
        } catch(e) { qDiv.innerHTML = 'âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙÙˆÙ„Ø¯Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª'; }
    }

    function save(qid, aid, btn) {
        userAnswers[qid] = aid;
        const parent = btn.parentElement;
        parent.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    async function submitExam() {
        const btn = document.getElementById('submit-btn');
        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ­ÙŠØ­...';
        btn.disabled = true;

        const url = `https://api.coursatk.online/api/v1/user/exams/${currentId}/submit`;
        const headers = { "Content-Type": "application/json", "Authorization": TOKEN };

        try {
            // 1. ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
            const res = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ answers: userAnswers })
            });
            const result = await res.json();

            if(res.ok) {
                // 2. Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… result_id
                const resultId = result.data.result.result_id;
                await fetchDetails(resultId);
            } else {
                alert('Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: ' + (result.error || 'ÙØ´Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…'));
            }
        } catch(e) {
            alert('Ù…Ø´ÙƒÙ„Ø© CORS! ÙØ¹Ù„ Ø¥Ø¶Ø§ÙØ© Allow CORS ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.');
        } finally {
            btn.innerText = 'ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø³ÙŠØ±ÙØ±';
            btn.disabled = false;
        }
    }

    async function fetchDetails(resultId) {
        const url = `https://api.coursatk.online/api/v1/user/exams/results/${resultId}`;
        const res = await fetch(url, { method: 'GET', headers: { "Authorization": TOKEN } });
        const json = await res.json();
        const data = json.data;

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø²Ø±Ø§Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        document.getElementById('quiz-questions').innerHTML = '';
        document.getElementById('submit-btn').style.display = 'none';
        const display = document.getElementById('result-display');
        display.style.display = 'block';

        // Ù…Ù„Ø®Øµ
        document.getElementById('result-summary').innerHTML = `
            Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span class="correct">${data.result.score}</span> / ${data.result.total_questions * 4}<br>
            Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: ${data.result.percentage}%
        `;

        // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        let detailsHtml = '';
        data.questions.forEach((q, i) => {
            const isCorrect = q.is_correct;
            detailsHtml += `
                <div class="q-result">
                    <p><strong>Ø³ ${i+1}: ${q.text}</strong></p>
                    <p class="${isCorrect ? 'correct' : 'wrong'}">
                        ${isCorrect ? 'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©' : 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'}
                    </p>
                    <p style="font-size:0.9rem;">
                        Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${q.user_answer_text || 'Ù„Ù… ØªØ¬Ø¨'}<br>
                        Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <span class="correct">${q.correct_answer_text}</span>
                    </p>
                </div>
            `;
        });
        document.getElementById('result-details').innerHTML = detailsHtml;
    }
</script>
</body>
</html>
