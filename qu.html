<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø³Ùˆ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸš€</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --accent-color: #58a6ff;
            --success-color: #3fb950;
            --error-color: #f85149;
            --border-color: #30363d;
        }

        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; direction: rtl; }
        header { text-align: center; padding: 20px; background: #161b22; border-bottom: 1px solid var(--border-color); }
        .container { max-width: 850px; margin: 0 auto; padding: 20px; }
        
        #searchBar {
            width: 100%; max-width: 400px; padding: 12px; margin: 10px auto; display: block;
            border-radius: 8px; border: 1px solid var(--border-color); background: #0d1117; color: white;
        }

        .exams-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .exam-card { background: var(--card-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.3s; }
        .exam-card:hover { border-color: var(--accent-color); transform: translateY(-3px); }

        #quiz-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1000; display: none; overflow-y: auto; padding: 20px; }
        .question-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .opt-btn { background: #21262d; border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 8px; text-align: right; font-family: inherit; }
        .opt-btn.selected { background: #1f6feb; border-color: white; }

        .btn-submit { background: #238636; color: white; padding: 12px 30px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; display: block; margin: 20px auto; font-family: inherit; width: 100%; max-width: 300px; }
        
        #result-display { padding: 20px; background: var(--card-bg); border: 1px solid var(--accent-color); border-radius: 12px; margin-top: 20px; display: none; }
        .q-res-box { background:#0d1117; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
        .correct-tag { color: var(--success-color); font-weight: bold; }
        .wrong-tag { color: var(--error-color); font-weight: bold; }
    </style>
</head>
<body>

<div id="dashboard">
    <header>
        <h1>Ù…Ù†ØµØ© Ø³Ùˆ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© âš¡</h1>
        <input type="text" id="searchBar" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...">
    </header>
    <div class="container">
        <div class="exams-grid" id="exams-list"></div>
    </div>
</div>

<div id="quiz-overlay">
    <div class="container">
        <button onclick="location.reload()" style="background:none; border:none; color:var(--accent-color); cursor:pointer; font-size:1.1rem; margin-bottom:20px;">â¬… Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <h2 id="quiz-title"></h2>
        <div id="quiz-questions"></div>
        
        <div id="result-display">
            <div id="result-summary"></div>
            <div id="result-details"></div>
        </div>

        <button class="btn-submit" id="submit-btn" onclick="submitExam()">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØªØµØ­ÙŠØ­Ù‡</button>
    </div>
</div>

<script>
    let currentId = null;
    let userAnswers = {}; 
    const TOKEN = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo1MTM1OSwicm9sZSI6InN0dWRlbnQiLCJ1dWlkIjoiNDAyOTZkM2YxMDg4ZGM5ZjRmMWQ2MTE0ZjcwM2U2MDQifQ.RoPKriladUHqzewaO3D1F9_XWVdLiqyYRh_06aorQQI";

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    const list = document.getElementById('exams-list');
    for(let i=42; i<=700; i++) {
        const d = document.createElement('div');
        d.className = 'exam-card'; d.innerHTML = `<h3>Ø§Ø®ØªØ¨Ø§Ø± #${i}</h3>`;
        d.onclick = () => openQuiz(i);
        list.appendChild(d);
    }

    // Ø¨Ø­Ø«
    document.getElementById('searchBar').oninput = (e) => {
        const v = e.target.value;
        document.querySelectorAll('.exam-card').forEach(c => c.style.display = c.innerText.includes(v) ? 'block' : 'none');
    };

    async function openQuiz(id) {
        currentId = id; userAnswers = {};
        document.getElementById('quiz-overlay').style.display = 'block';
        document.getElementById('result-display').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'block';
        const qDiv = document.getElementById('quiz-questions');
        qDiv.innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ù…Ø­Ù„ÙŠØ©...</p>';

        try {
            const res = await fetch(`Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª/exam_${id}.json`);
            const json = await res.json();
            const data = json.data.data;
            document.getElementById('quiz-title').innerText = data.exam.title;
            qDiv.innerHTML = '';

            data.questions.forEach(q => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.innerHTML = `<p><strong>${q.text}</strong></p>
                    ${q.image_url ? `<img src="${q.image_url}" style="max-width:100%; border-radius:8px; margin-bottom:10px;">` : ''}
                    <div>${q.answers.map(a => `<button class="opt-btn" onclick="save('${q.id}','${a.id}',this)">${a.text}</button>`).join('')}</div>`;
                qDiv.appendChild(card);
            });
        } catch(e) { qDiv.innerHTML = '<p style="text-align:center; color:red;">âŒ Ù…Ù„Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ØªÙˆÙØ± (ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø£ÙˆÙ„Ø§Ù‹)</p>'; }
    }

    function save(qid, aid, btn) {
        userAnswers[qid.toString()] = aid.toString(); 
        btn.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    async function submitExam() {
        const btn = document.getElementById('submit-btn');
        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...'; btn.disabled = true;

        try {
            // 1. Ø§Ù„ØªØ³Ù„ÙŠÙ… (POST)
            const res = await fetch(`https://api.coursatk.online/api/v1/user/exams/${currentId}/submit`, {
                method: 'POST',
                headers: { "Content-Type": "application/json", "Authorization": TOKEN },
                body: JSON.stringify({ answers: userAnswers })
            });
            const result = await res.json();

            if(res.ok) {
                // 2. Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (GET) Ø¨Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø¸Ø¨ÙˆØ· /exam/result/
                const resultId = result.data.result.result_id;
                await fetchResultDetails(resultId);
            } else {
                alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±ÙØ¶ Ø§Ù„ØªØ³Ù„ÙŠÙ…: ' + (result.error || 'Ø®Ø·Ø£ Ù…Ø¬Ù‡ÙˆÙ„'));
            }
        } catch(e) { alert('CORS Error! ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø¥Ø¶Ø§ÙØ© CORS ÙÙŠ Ù…ØªØµÙØ­Ùƒ.'); }
        finally { btn.innerText = 'ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØªØµØ­ÙŠØ­Ù‡'; btn.disabled = false; }
    }

    async function fetchResultDetails(rid) {
        const res = await fetch(`https://api.coursatk.online/api/v1/user/exams/result/${rid}`, { 
            method: 'GET', headers: { "Authorization": TOKEN } 
        });
        const responseData = await res.json();
        
        // Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø£Ø®ÙŠØ± Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        const mainData = responseData.data.data;
        const resultSummary = mainData.result;
        const questionsList = mainData.questions;

        document.getElementById('quiz-questions').innerHTML = '';
        document.getElementById('submit-btn').style.display = 'none';
        const display = document.getElementById('result-display');
        display.style.display = 'block';

        // Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒÙˆØ±
        document.getElementById('result-summary').innerHTML = `
            <div style="text-align:center; background:#23863622; padding:20px; border-radius:10px; border:1px solid #238636; margin-bottom:20px;">
                <h2 style="margin:0;">Ø¯Ø±Ø¬ØªÙƒ: ${resultSummary.score} / ${resultSummary.total_questions * 4}</h2>
                <p>Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©: ${resultSummary.correct_answers} Ù…Ù† ${resultSummary.total_questions}</p>
            </div>
        `;

        let detailsHtml = '<h3 style="margin-bottom:15px;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:</h3>';
        questionsList.forEach((q, i) => {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ØµÙˆØµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ù† Ù…ØµÙÙˆÙØ© Ø§Ù„Ù€ answers
            const correctOpt = q.answers.find(a => a.id == q.correct_answer_id);
            const userOpt = q.answers.find(a => a.id == q.user_answer_id);

            detailsHtml += `
                <div class="q-res-box" style="border-right: 5px solid ${q.is_correct ? 'var(--success-color)' : 'var(--error-color)'}">
                    <p><strong>Ø³ ${i+1}: ${q.text}</strong></p>
                    <p class="${q.is_correct ? 'correct-tag' : 'wrong-tag'}">${q.is_correct ? 'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©' : 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'}</p>
                    <p style="font-size:0.95rem;">Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${userOpt ? userOpt.text : 'Ù„Ù… ØªØ¬Ø¨'}</p>
                    ${!q.is_correct ? `<p>Ø§Ù„ØµØ­: <span class="correct-tag">${correctOpt ? correctOpt.text : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></p>` : ''}
                </div>
            `;
        });
        document.getElementById('result-details').innerHTML = detailsHtml;
    }
</script>
</body>
</html>
