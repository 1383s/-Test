<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ù…Ù„Ø®ØµØ§Øª ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js"></script>
    <script type="module" src="devcheck.js"></script>
    <script src="auth.js"></script>
    
    <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'bg-main': '#020A07',     
            'bg-card': '#0C241C',     
            'accent': '#08402C',      
            'glass-border': 'rgba(8, 64, 44, 0.4)', 
            'text-primary': '#E6F0E8', 
          },
          fontFamily: { sans: ['Cairo', 'sans-serif'] }
        }
      }
    }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
    /* ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù€ Glassmorphism */
    body { 
        font-family: 'Cairo', sans-serif; 
        background-color: #020A07; 
        color: #E6F0E8; 
        margin:0; 
    }
    .glass-panel {
      background: rgba(12, 36, 28, 0.7); 
      backdrop-filter: blur(15px);
      border: 1px solid #08402C; 
    }
    .glass-card {
      background: rgba(12, 36, 28, 0.5); 
      backdrop-filter: blur(8px);
      border: 1px solid rgba(8, 64, 44, 0.3); 
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
    }
    .glass-card:hover {
      background: rgba(8, 64, 44, 0.7); 
      transform: translateY(-2px);
      border-color: #08402C;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .accent-text { color: #08402C; }
    .accent-bg { background-color: #08402C; }
    .toast {
      min-width:200px; max-width:300px; padding:0.75rem 1rem; border-radius:0.5rem; color:white; font-weight:500; box-shadow:0 4px 12px rgba(0, 0, 0, 0.5);
      position: fixed; bottom: 20px; right: 20px; z-index: 1000;
      transition: all 0.3s ease;
    }
    .toast.info { background-color: #0099cc; } 
    .toast.success { background-color: #10b981; }
    .toast.error { background-color: #ef4444; }
    .loading-dialog {
      position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; flex-direction:column; color:white;
    }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">

<div id="app" class="flex-1 flex flex-col h-full overflow-hidden p-4 md:p-6 lg:p-8">

    <header class="glass-panel h-16 flex items-center justify-between px-4 md:px-6 mb-8 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="accent-bg/20 p-2 rounded-lg accent-text flex items-center justify-center">
                <i class="ph ph-books text-2xl"></i>
            </div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-accent to-text-primary bg-clip-text text-transparent">
                 Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ù…Ù„Ø®ØµØ§Øª ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©
            </h1>
        </div>

        <div class="text-sm font-medium text-gray-400">
            Ø´Ø¹Ø¨ØªÙŠ: <span class="text-text-primary">{{ studentDivision || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' }}</span>
        </div>
    </header>


    <div v-if="loading" class="loading-dialog">
        <i class="ph ph-spinner-gap animate-spin text-5xl mb-4 accent-text"></i>
        <p class="text-lg">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø¹Ø¨Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¯Ù‰...</p>
        <p v-if="!studentCode" class="text-red-400 mt-2">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. (ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)</p>
    </div>


    <main v-else class="flex-1 overflow-y-auto">
        
        <div v-if="!activeSubject" class="max-w-6xl mx-auto space-y-4">
            <h2 class="text-3xl font-bold text-text-primary mb-6">
                Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®ØµØ§Øª
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div v-for="subject in subjects" :key="subject.name" @click="selectSubject(subject.name)"
                    class="glass-card rounded-xl p-5 cursor-pointer group flex items-center gap-4 hover:scale-[1.02] transition-transform duration-200">
                    <i class="ph ph-folder text-4xl accent-text group-hover:text-text-primary transition-colors"></i>
                    <div>
                        <h3 class="font-bold text-lg text-text-primary">{{ subject.displayName }}</h3>
                        <p class="text-sm text-gray-500">{{ subject.topic }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-else class="max-w-7xl mx-auto space-y-6">
            <div class="flex items-center justify-between mb-6 border-b border-accent/50 pb-3">
                <div class="flex items-center gap-3">
                    <button @click="activeSubject = null; loadImages()" class="text-gray-400 hover:text-accent transition-colors text-sm font-medium flex items-center gap-1">
                        <i class="ph ph-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙÙˆÙ„Ø¯Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
                    </button>
                    <h2 class="text-3xl font-bold text-text-primary">{{ activeSubjectDisplayName }}</h2>
                </div>
                
                <button @click="document.getElementById('imageUploader').click()"
                    class="accent-bg text-text-primary px-4 py-2 rounded-lg font-semibold hover:bg-accent/80 transition-colors flex items-center gap-2">
                    <i class="ph ph-file-image text-xl"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ (ØµÙˆØ±)
                </button>
                <input type="file" id="imageUploader" accept="image/*" multiple @change="handleImageUpload" style="display: none;">
            </div>

            <div v-if="imagesLoading" class="text-center text-gray-500 p-10">
                 <i class="ph ph-spinner-gap animate-spin text-3xl mb-3 accent-text"></i>
                 <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø®ØµØ§Øª...</p>
            </div>
            
            <div v-else-if="!currentImages.length" class="text-center text-gray-500 p-10 glass-card">
                <i class="ph ph-info text-4xl mb-3 accent-text"></i>
                <p>Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ù…Ù„Ø®ØµØ§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ø¹Ø¯.</p>
            </div>

            <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="image in currentImages" :key="image.id" class="glass-card rounded-xl overflow-hidden shadow-xl">
                    <div class="relative bg-bg-main/50 overflow-hidden" style="max-height: 400px;">
                        <img :src="image.base64" alt="Ù…Ù„Ø®Øµ Ø·Ø§Ù„Ø¨" class="w-full object-contain" @error="handleImageError">
                    </div>
                    <div class="p-4 border-t border-accent/50 flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400">Ù…Ù„Ø®Øµ Ù…ÙØ±Ø³Ù„ Ø¨ÙˆØ§Ø³Ø·Ø©:</p>
                            <span class="font-mono text-sm text-accent-text">{{ image.senderCode }}</span>
                        </div>
                        <span class="text-xs text-gray-500">{{ image.timeSent }}</span>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <div id="toast-container">
        <div v-for="toast in toasts" :key="toast.id" :class="['toast', toast.type]">
            {{ toast.message }}
        </div>
    </div>
</div>

<script>
const { createApp, ref, reactive, computed } = Vue;

// ğŸš¨ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase
const CODES_REF_PATH = 'approvedStudents';
const FORUM_REF_PATH = 'forum';
const STUDENT_CODE_KEY = "activeCode"; 

// ğŸš¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€ Toasts
const toasts = ref([]);
const showToast = (message, type='info', duration=4000) => {
     const id = Date.now() + Math.random();
    toasts.value.push({ id, message, type });
    setTimeout(() => {
        const index = toasts.value.findIndex(t => t.id === id);
        if(index !== -1) toasts.value.splice(index,1);
    }, duration);
};

// ğŸš¨ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù€ Base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

createApp({
    setup() {
        const loading = ref(true);
        const imagesLoading = ref(false);
        const studentCode = ref(localStorage.getItem(STUDENT_CODE_KEY));
        const studentDivision = ref(null);
        const activeSubject = ref(null); 
        const currentImages = ref([]);   
        
        // Firebase Setup
        const db = firebase.database();

        // ğŸš¨ ØªØ­Ø¯ÙŠØ¯ ÙÙˆÙ„Ø¯Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¹Ø¨Ø©
        const SUBJECTS_MAP = {
            'Ø§Ø¯Ø¨ÙŠ': [
                { name: 'statistics', displayName: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¡', topic: 'Ù…Ù„Ø®ØµØ§Øª ÙˆÙ‚ÙˆØ§Ù†ÙŠÙ†' },
                { name: 'geography', displayName: 'Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§', topic: 'Ø®Ø±Ø§Ø¦Ø· ÙˆÙ…ÙØ§Ù‡ÙŠÙ…' },
                { name: 'history', displayName: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', topic: 'Ø£Ø­Ø¯Ø§Ø« ÙˆØªÙˆØ§Ø±ÙŠØ®' },
                { name: 'arabic', displayName: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', topic: 'Ù†Ø­Ùˆ ÙˆØ¨Ù„Ø§ØºØ©' },
                { name: 'english', displayName: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', topic: 'ÙƒÙ„Ù…Ø§Øª ÙˆÙ‚ÙˆØ§Ø¹Ø¯' },
            ],
            'Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©': [
                { name: 'math', displayName: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', topic: 'Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆÙ…Ø³Ø§Ø¦Ù„' },
                { name: 'physics', displayName: 'Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', topic: 'Ù†Ø¸Ø±ÙŠØ§Øª ÙˆÙ…Ø³Ø§Ø¦Ù„' },
                { name: 'chemistry', displayName: 'Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', topic: 'Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ÙˆÙ…Ø±ÙƒØ¨Ø§Øª' },
                { name: 'arabic', displayName: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', topic: 'Ù†Ø­Ùˆ ÙˆØ¨Ù„Ø§ØºØ©' },
                { name: 'english', displayName: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', topic: 'ÙƒÙ„Ù…Ø§Øª ÙˆÙ‚ÙˆØ§Ø¹Ø¯' },
            ],
            'Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…': [
                { name: 'biology', displayName: 'Ø§Ù„Ø£Ø­ÙŠØ§Ø¡', topic: 'Ø±Ø³ÙˆÙ…Ø§Øª ÙˆØªÙØ§ØµÙŠÙ„' },
                { name: 'physics', displayName: 'Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', topic: 'Ù†Ø¸Ø±ÙŠØ§Øª ÙˆÙ…Ø³Ø§Ø¦Ù„' },
                { name: 'chemistry', displayName: 'Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', topic: 'Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ÙˆÙ…Ø±ÙƒØ¨Ø§Øª' },
                { name: 'arabic', displayName: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', topic: 'Ù†Ø­Ùˆ ÙˆØ¨Ù„Ø§ØºØ©' },
                { name: 'english', displayName: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', topic: 'ÙƒÙ„Ù…Ø§Øª ÙˆÙ‚ÙˆØ§Ø¹Ø¯' },
            ],
            'Ø§Ø²Ù‡Ø±': [
                { name: 'arabic_azhar', displayName: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø£Ø²Ù‡Ø±)', topic: 'ÙÙ‚Ù‡ ÙˆÙ†Ø­Ùˆ' },
                { name: 'islamic_studies', displayName: 'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©', topic: 'Ø­Ø¯ÙŠØ« ÙˆØªÙØ³ÙŠØ±' },
                { name: 'general', displayName: 'Ù…ÙˆØ§Ø¯ Ø¹Ø§Ù…Ø© (Ø£Ø²Ù‡Ø±)', topic: 'Ù…Ù„Ø®ØµØ§Øª Ù…ØªÙ†ÙˆØ¹Ø©' },
            ]
        };

        // ğŸš¨ Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø© Ù…Ù† Firebase (Ù…Ø¹ Ù„ÙˆØ¬ÙŠÙƒ Ø§Ù„Ù€ Fallback)
        const fetchStudentDivision = async () => {
            if (!studentCode.value) {
                loading.value = false;
                studentDivision.value = 'Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…'; // Fallback Ù„Ø¥Ø¸Ù‡Ø§Ø± ÙÙˆÙ„Ø¯Ø±Ø§Øª
                showToast("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ localStorage. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.", "error");
                return;
            }

            try {
                showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¹Ø¨Ø©...", "info");
                // âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©
                const snapshot = await db.ref(`${CODES_REF_PATH}/${studentCode.value}/section`).once('value');
                const division = snapshot.val(); 

                if (division && SUBJECTS_MAP[division]) {
                    studentDivision.value = division;
                    showToast(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø¹Ø¨Ø©: ${division}`, "success");
                } else {
                    studentDivision.value = 'Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…'; // Fallback Ù„Ùˆ Ø§Ù„Ø´Ø¹Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©
                    showToast("âš  Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø¹Ø¨Ø©ØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¯ 'Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…' Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§.", "warn");
                }
            } catch (err) {
                 // âš ï¸ Ù„Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ Firebase (Fatal Error)
                 console.error("Firebase Initialization/Access Error:", err);
                 studentDivision.value = 'Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…';
                 showToast("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Firebase. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¯ 'Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…' Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§.", "error");
            } finally {
                loading.value = false;
            }
        }
        
        // ğŸš¨ Computed Property Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆÙ„Ø¯Ø±Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¹Ø¨Ø©
        const subjects = computed(() => {
            return SUBJECTS_MAP[studentDivision.value] || [];
        });
        
        // ğŸš¨ Computed Property Ù„Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        const activeSubjectDisplayName = computed(() => {
            if (!activeSubject.value) return '';
            const sub = subjects.value.find(s => s.name === activeSubject.value);
            return sub ? sub.displayName : activeSubject.value;
        });

        // ğŸš¨ Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
        const selectSubject = (subjectName) => {
            activeSubject.value = subjectName;
            loadImages();
        };

        // ğŸš¨ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        const loadImages = () => {
            if (!activeSubject.value || !studentDivision.value) return;
            imagesLoading.value = true;
            currentImages.value = []; 

            const subjectKey = activeSubject.value;
            const divisionKey = studentDivision.value;
            
            // Ø§Ù„Ù…Ø³Ø§Ø±: forum/Ø§Ø¯Ø¨ÙŠ/history
            const path = `${FORUM_REF_PATH}/${divisionKey}/${subjectKey}`;

            db.ref(path).on('value', (snapshot) => {
                const data = snapshot.val();
                const imagesArray = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        imagesArray.push({
                            id: key,
                            ...data[key],
                            // Ù†Ø¶Ù…Ù† Ø£Ù† base64 Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„Ø¹Ø±Ø¶
                            base64: data[key].base64Image || 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==' 
                        });
                    });
                }
                
                // Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
                imagesArray.sort((a, b) => b.time - a.time);

                currentImages.value = imagesArray;
                imagesLoading.value = false;
                
                if (activeSubject.value && imagesArray.length > 0) {
                   showToast(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${imagesArray.length} Ù…Ù„Ø®Øµ.`, "success");
                }
            });
        };

        // ğŸš¨ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
        const handleImageUpload = async (event) => {
            if (!activeSubject.value || !studentCode.value) {
                showToast("âŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.", "error");
                return;
            }

            const files = event.target.files;
            if (files.length === 0) return;
            
            showToast(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${files.length} ØµÙˆØ±Ø©... Ù‡Ø°Ø§ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªÙ‹Ø§.`, "info");

            const uploadPromises = [];
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    showToast(`âŒ Ø§Ù„Ù…Ù„Ù ${file.name} Ù„ÙŠØ³ ØµÙˆØ±Ø©.`, "error");
                    continue;
                }
                
                // Ù‚ÙŠÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ù…
                if (file.size > 2 * 1024 * 1024) { // 2MB
                     showToast(`âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ${file.name} ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØ¬Ø§).`, "error");
                     continue;
                }

                uploadPromises.push(
                    fileToBase64(file).then(base64Image => {
                        const newPostRef = db.ref(`${FORUM_REF_PATH}/${studentDivision.value}/${activeSubject.value}`).push();
                        
                        return newPostRef.set({
                            senderCode: studentCode.value,
                            base64Image: base64Image,
                            time: firebase.database.ServerValue.TIMESTAMP,
                            timeSent: new Date().toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' }),
                            fileName: file.name
                        });
                    })
                );
            }

            try {
                await Promise.all(uploadPromises);
                showToast(`âœ… ØªÙ… Ø±ÙØ¹ ${files.length} Ù…Ù„Ø®Øµ Ø¨Ù†Ø¬Ø§Ø­!`, "success");
            } catch (err) {
                console.error("Upload Error:", err);
                showToast("âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Firebase.", "error");
            }
        };
        
        // ğŸš¨ Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© (Ù„Ùˆ Ø§Ù„Ù€ Base64 ØºÙ„Ø·)
        const handleImageError = (e) => {
            e.target.src = 'https://via.placeholder.com/400x300?text=Image+Load+Error';
        }
        
        // ğŸš¨ Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        fetchStudentDivision();

        return { 
            loading, 
            imagesLoading,
            studentCode,
            studentDivision, 
            subjects,
            activeSubject,
            activeSubjectDisplayName,
            currentImages,
            selectSubject,
            handleImageUpload,
            handleImageError,
            loadImages,
            toasts // Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ Toast ÙÙŠ Ø§Ù„Ù€ DOM
        };
    }
}).mount('#app');
</script>

</body>
</html>
