<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --bg-dark: #0b0e14;
            --card-bg: #151921;
            --border-color: #30363d;
            --text-main: #adbac7;
            --accent-green: #238636;
            --accent-blue: #1f6feb;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main); 
            padding: 20px; 
            margin: 0; 
        }

        .container { max-width: 800px; margin: 0 auto; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        .quiz-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-action { 
            background: transparent; 
            border: 1px solid var(--border-color); 
            color: var(--text-main); 
            padding: 8px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.3s; 
            text-decoration: none; 
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-action:hover { background: #22272e; border-color: var(--accent-blue); }
        .btn-pdf { border-color: #f40f02; color: #f40f02; }
        .btn-pdf:hover { background: rgba(244, 15, 2, 0.1); border-color: #f40f02; }

        .q-count-badge { 
            background: rgba(31, 111, 235, 0.2); 
            color: #58a6ff; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: bold; 
        }

        .q-card { 
            background: var(--card-bg); 
            border-radius: 15px; 
            padding: 25px; 
            margin-bottom: 25px; 
            border: 1px solid var(--border-color); 
            page-break-inside: avoid; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…ÙŠØªÙØµÙ„Ø´ ÙÙŠ Ù†Øµ ØµÙØ­ØªÙŠÙ† PDF */
        }

        .opt { 
            display: block; 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            background: #22272e; 
            border: 1px solid var(--border-color); 
            color: #fff; 
            border-radius: 10px; 
            cursor: pointer; 
            text-align: right; 
            transition: 0.2s; 
        }

        .opt.selected { 
            background: var(--accent-blue) !important; 
            border-color: #58a6ff !important; 
            font-weight: bold; 
        }

        .submit-btn { 
            background: var(--accent-green); 
            color: #fff; 
            padding: 18px; 
            border: none; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            font-size: 1.2rem; 
            margin-top: 20px; 
        }

        #title { color: #fff; margin: 10px 0; }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ ÙÙ‚Ø· */
        .no-print { display: none; }
    </style>
</head>
<body>

    <div class="container" id="quizContent">
        <div class="quiz-header">
            <a href="javascript:history.back()" class="btn-action">
                <i class="fas fa-chevron-right"></i> Ø±Ø¬ÙˆØ¹
            </a>
            
            <button onclick="downloadPDF()" class="btn-action btn-pdf" id="pdfBtn">
                <i class="fas fa-file-pdf"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± PDF
            </button>

            <span id="qCountDisplay" class="q-count-badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</span>
        </div>

        <h2 id="title">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</h2>
        
        <div id="questions"></div>
        
        <button class="submit-btn" id="finalSubmitBtn" onclick="submit()">
            <i class="fas fa-paper-plane"></i> ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØªØµØ­ÙŠØ­Ù‡ ğŸš€
        </button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const examId = params.get('id');
        let userAnswers = {};
        const TOKEN = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo1MTM1OSwicm9sZSI6InN0dWRlbnQiLCJ1dWlkIjoiNDAyOTZkM2YxMDg4ZGM5ZjRmMWQ2MTE0ZjcwM2U2MDQifQ.RoPKriladUHqzewaO3D1F9_XWVdLiqyYRh_06aorQQI";

        async function load() {
            try {
                const res = await fetch(`Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª/exam_${examId}.json`);
                const json = await res.json();
                
                document.getElementById('title').innerText = json.data.data.exam.title;
                
                const questionsArray = json.data.data.questions;
                document.getElementById('qCountDisplay').innerText = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${questionsArray.length}`;

                const questionsContainer = document.getElementById('questions');
                questionsArray.forEach((q, index) => {
                    const div = document.createElement('div');
                    div.className = 'q-card';
                    div.innerHTML = `
                        <p><strong>Ø³Ø¤Ø§Ù„ ${index + 1}:</strong> ${q.text}</p>
                        ${q.image_url ? `<img src="${q.image_url}" style="max-width:100%; border-radius:12px; margin-bottom:15px; border: 1px solid #30363d;">` : ''}
                        <div id="q-${q.id}">
                            ${q.answers.map(a => `
                                <button class="opt" onclick="sel('${q.id}','${a.id}',this)">${a.text}</button>
                            `).join('')}
                        </div>`;
                    questionsContainer.appendChild(div);
                });
            } catch(e) { 
                alert("Ù…Ù„Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯!"); 
            }
        }

        function sel(qid, aid, btn) {
            userAnswers[qid] = aid;
            const parent = btn.parentElement;
            parent.querySelectorAll('.opt').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù€ PDF
        function downloadPDF() {
            const element = document.getElementById('quizContent');
            const examTitle = document.getElementById('title').innerText;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ø´Ø§Ù† Ù…ØªØ·Ù„Ø¹Ø´ ÙÙŠ Ø§Ù„Ù€ PDF
            const pdfBtn = document.getElementById('pdfBtn');
            const submitBtn = document.getElementById('finalSubmitBtn');
            pdfBtn.style.display = 'none';
            submitBtn.style.display = 'none';

            const opt = {
                margin:       [10, 10, 10, 10],
                filename:     `${examTitle}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, backgroundColor: '#0b0e14' },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
                pdfBtn.style.display = 'flex';
                submitBtn.style.display = 'block';
            });
        }

        async function submit() {
            const res = await fetch(`https://api.coursatk.online/api/v1/user/exams/${examId}/submit`, {
                method: 'POST', 
                headers: { "Content-Type": "application/json", "Authorization": TOKEN },
                body: JSON.stringify({ answers: userAnswers })
            });
            const data = await res.json();
            if(res.ok) window.location.href = `results.html?rid=${data.data.result.result_id}`;
        }

        load();
    </script>
</body>
</html>
