<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø´Ø§ØªÙŠ - Ù…Ø­Ù…Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        body { font-family: 'Cairo', sans-serif; background: #020A07; color: #27d97e; text-align: center; padding: 50px; }
        #progress-container { margin-top: 20px; display: none; }
        #progress-bar { width: 100%; background: #0C241C; border-radius: 10px; height: 20px; border: 1px solid #27d97e; }
        #progress-fill { height: 100%; width: 0%; background: #27d97e; transition: width 0.3s; }
        button { background: #27d97e; color: #000; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <h1>ğŸ“¥ Ù…Ø­Ù…Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (M3U8 to MP4)</h1>
    <p>Ø¨Øµ ÙŠØ§ Ø³ÙˆØŒ Ø­Ø· Ø§Ù„Ù„ÙŠÙ†Ùƒ Ù‡Ù†Ø§ ÙˆÙ‡Ø­Ø§ÙˆÙ„ Ø£Ø¬Ù…Ø¹Ù‡ÙˆÙ„Ùƒ Ù‚Ø·Ø¹Ø© Ù‚Ø·Ø¹Ø©</p>
    
    <input type="text" id="videoUrl" placeholder="Ø­Ø· Ù„ÙŠÙ†Ùƒ Ø§Ù„Ù€ m3u8 Ù‡Ù†Ø§" style="width: 80%; padding: 10px; margin-bottom: 20px;">
    <br>
    <button onclick="startDownload()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†</button>

    <div id="progress-container">
        <p id="status">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...</p>
        <div id="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/m3u8-parser/4.7.1/m3u8-parser.min.js"></script>

    <script>
        async function startDownload() {
            const url = document.getElementById('videoUrl').value;
            if (!url) return alert("ÙÙŠÙ† Ø§Ù„Ù„ÙŠÙ†Ùƒ ÙŠØ§ Ø¨Ø·Ù„ØŸ");

            const status = document.getElementById('status');
            const progressFill = document.getElementById('progress-fill');
            document.getElementById('progress-container').style.display = 'block';

            try {
                // 1. ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ÙÙ‡Ø±Ø³
                status.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ‡Ø±Ø³...";
                const response = await fetch(url);
                const manifest = await response.text();

                // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Segments)
                const parser = new m3u8Parser.Parser();
                parser.push(manifest);
                parser.end();

                const segments = parser.manifest.segments;
                const total = segments.length;
                let videoBlobs = [];

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù€ Base URL
                const baseUrl = url.substring(0, url.lastIndexOf('/') + 1);

                // 3. ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ù‚Ø·Ø¹Ø© (Segment)
                for (let i = 0; i < total; i++) {
                    const segmentUrl = segments[i].uri.startsWith('http') ? segments[i].uri : baseUrl + segments[i].uri;
                    const segRes = await fetch(segmentUrl);
                    const segData = await segRes.blob();
                    videoBlobs.push(segData);

                    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                    const percent = Math.round(((i + 1) / total) * 100);
                    progressFill.style.width = percent + "%";
                    status.textContent = `Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø¹Ø© ${i + 1} Ù…Ù† ${total}...`;
                }

                // 4. ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ù€ Blobs ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯
                status.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ù„Ø­Ø¸Ø© ÙˆØ§Ø­Ø¯Ø©...";
                const finalBlob = new Blob(videoBlobs, { type: 'video/mp4' });
                const downloadUrl = URL.createObjectURL(finalBlob);

                // 5. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = "full-video.mp4";
                a.click();
                
                status.textContent = "Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù†Ø²Ù„ ÙƒØ§Ù…Ù„ ÙŠØ§ ÙˆØ­Ø´ ğŸš€";

            } catch (error) {
                console.error(error);
                status.textContent = "Ø­ØµÙ„ Ù…Ø´ÙƒÙ„Ø© (ØºØ§Ù„Ø¨Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ù€ CORS Ø£Ùˆ Ø§Ù„Ù„ÙŠÙ†Ùƒ Ù…Ù†ØªÙ‡ÙŠ).";
            }
        }
    </script>
</body>
</html>
