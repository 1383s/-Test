<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø­Ù…Ù„ Ø´Ø§ØªÙŠ Ø§Ù„Ø°ÙƒÙŠ - Debug Mode</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Fira+Code&display=swap');
        :root { --neon: #27d97e; --bg: #020A07; --error: #ff4d4d; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--neon); padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: auto; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #0C241C; border: 1px solid var(--neon); color: #fff; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--neon); color: #000; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        
        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ */
        #console-log {
            background: #000;
            color: #00ff00;
            font-family: 'Fira Code', monospace;
            text-align: left;
            padding: 15px;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 13px;
            white-space: pre-wrap;
            direction: ltr; /* Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ø§Ù† ØµØ­ */
        }
        .err { color: var(--error); }
        .warn { color: #ffcc00; }
        .success { color: #00ff00; }
        
        #progress-bar { width: 100%; background: #0C241C; height: 10px; margin-top: 10px; border-radius: 5px; display: none; }
        #progress-fill { height: 100%; width: 0%; background: var(--neon); border-radius: 5px; transition: 0.3s; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸš€ M3U8 Downloader <small style="font-size: 12px;">v2.0</small></h1>
        <input type="text" id="videoUrl" placeholder="Paste m3u8 link here...">
        <button onclick="startDownload()">Start Processing</button>

        <div id="progress-bar"><div id="progress-fill"></div></div>
        
        <div id="console-log">>> System Ready. Waiting for link...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/m3u8-parser/4.7.1/m3u8-parser.min.js"></script>

    <script>
        const logger = document.getElementById('console-log');
        const fill = document.getElementById('progress-fill');
        const bar = document.getElementById('progress-bar');

        function log(msg, type = '') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${time}] ${msg}`;
            logger.appendChild(div);
            logger.scrollTop = logger.scrollHeight;
        }

        async function startDownload() {
            const url = document.getElementById('videoUrl').value.trim();
            if (!url) return log("Error: No URL provided!", "err");

            log("Starting request to: " + url.substring(0, 50) + "...");
            bar.style.display = 'block';
            
            try {
                // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª
                const response = await fetch(url).catch(e => {
                    if(e.message.includes('Failed to fetch')) {
                        throw new Error("CORS_ERROR: Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±Ø§ÙØ¶ ÙŠØ¯ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ØªØµÙØ­ Ù…Ø¨Ø§Ø´Ø±Ø©. Ù„Ø§Ø²Ù… ØªØ³ØªØ®Ø¯Ù… Proxy Ø£Ùˆ Extension.");
                    }
                    throw e;
                });

                if (!response.ok) throw new Error(`HTTP_ERROR: Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±Ø¯ Ø¨ÙƒÙˆØ¯ ${response.status}. Ø§Ù„Ù„ÙŠÙ†Ùƒ Ø¯Ù‡ Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† Ø§Ù†ØªÙ‡Ù‰ Ø£Ùˆ Ù…Ø­Ù…ÙŠ.`);

                const manifest = await response.text();
                log("Manifest loaded successfully.", "success");

                // Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                const parser = new m3u8Parser.Parser();
                parser.push(manifest);
                parser.end();

                const segments = parser.manifest.segments;
                if (!segments || segments.length === 0) throw new Error("PARSE_ERROR: Ù…ÙÙŠØ´ Ø£Ø¬Ø²Ø§Ø¡ ÙÙŠØ¯ÙŠÙˆ (Segments) ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø¯Ù‡. Ø¬Ø±Ø¨ Ù„ÙŠÙ†Ùƒ Ø§Ù„Ù€ Master.");

                log(`Found ${segments.length} segments. Starting download sequence...`);

                const baseUrl = url.substring(0, url.lastIndexOf('/') + 1);
                let videoBlobs = [];

                // Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡
                for (let i = 0; i < segments.length; i++) {
                    const segmentUrl = segments[i].uri.startsWith('http') ? segments[i].uri : baseUrl + segments[i].uri;
                    
                    try {
                        const segRes = await fetch(segmentUrl);
                        if (!segRes.ok) throw new Error(`Segment ${i} failed.`);
                        const segData = await segRes.blob();
                        videoBlobs.push(segData);
                        
                        const percent = Math.round(((i + 1) / segments.length) * 100);
                        fill.style.width = percent + "%";
                        if (i % 5 === 0) log(`Progress: ${percent}% (Downloaded ${i+1}/${segments.length})`);
                    } catch (e) {
                        log(`Warning: Failed to download segment ${i}. Skipping...`, "warn");
                    }
                }

                // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„ØªØ¬Ù…ÙŠØ¹
                log("All segments downloaded. Merging into final MP4...", "warn");
                const finalBlob = new Blob(videoBlobs, { type: 'video/mp4' });
                const downloadUrl = URL.createObjectURL(finalBlob);

                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `video_${Date.now()}.mp4`;
                a.click();
                
                log("Download complete! Check your downloads folder.", "success");

            } catch (err) {
                log("CRITICAL ERROR: " + err.message, "err");
                console.error(err);
                
                if (err.message.includes('CORS')) {
                    log("ğŸ’¡ Ø§Ù„Ø­Ù„: Ù„Ø§Ø²Ù… ØªØ´ØºÙ„ Ø¥Ø¶Ø§ÙØ© 'Allow CORS' ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¨ØªØ§Ø¹Ùƒ Ø¹Ø´Ø§Ù† ØªØªØ®Ø·Ù‰ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø³ÙŠØ±ÙØ±.", "warn");
                }
            }
        }
    </script>
</body>
</html>
